import streamlit as st
import numpy as np
import pandas as pd
import plotly.express as px

# Sayfa AyarlarÄ±
st.set_page_config(page_title="Backgammon Dice Economy Simulator", layout="wide")

st.title("ğŸ² Backgammon Plus: Growth & Economy Simulator")
st.markdown("""
Bu simÃ¼lasyon, zar toplama mekaniÄŸini (Coupon Collector Problem) ve oyun ekonomisini
farklÄ± parametrelerle test etmenizi saÄŸlar.
""")

# --- SIDEBAR: PARAMETRELER ---
st.sidebar.header("âš™ï¸ SimÃ¼lasyon Parametreleri")

# 1. SimÃ¼lasyon AyarlarÄ±
st.sidebar.subheader("1. Genel Ayarlar")
num_simulations = st.sidebar.slider("SimÃ¼lasyon SayÄ±sÄ± (N)", 1000, 50000, 10000, step=1000)

# 2. SandÄ±k MekaniÄŸi
st.sidebar.subheader("2. SandÄ±k (Chest) MekaniÄŸi")
base_pieces = st.sidebar.number_input("SandÄ±k BaÅŸÄ±na Garanti ParÃ§a", value=2, step=1)
ad_watch_prob = st.sidebar.slider("Reklam Ä°zleme OranÄ± (%)", 0, 100, 5) / 100
ad_bonus_pieces = st.sidebar.number_input("Reklamdan Gelen Ekstra ParÃ§a", value=1, step=1)
daily_chests = st.sidebar.slider("GÃ¼nlÃ¼k AÃ§Ä±lan SandÄ±k (Oyuncu HÄ±zÄ±)", 1, 10, 2)

# Ortalama ParÃ§a HesabÄ±
avg_pieces_per_chest = base_pieces + (ad_bonus_pieces * ad_watch_prob)
st.sidebar.info(f"ğŸ“Š SandÄ±k BaÅŸÄ±na Ort. ParÃ§a: **{avg_pieces_per_chest:.2f}**")

# 3. Zar YÃ¼zÃ¼ OlasÄ±lÄ±klarÄ± (Face Probabilities)
st.sidebar.subheader("3. Zar YÃ¼zÃ¼ OlasÄ±lÄ±klarÄ±")
st.sidebar.caption("ToplamÄ± 100 olacak ÅŸekilde aÄŸÄ±rlÄ±k verin.")
c1, c2, c3 = st.sidebar.columns(3)
f1 = c1.number_input("YÃ¼z 1", value=20)
f2 = c2.number_input("YÃ¼z 2 (Zor)", value=10)
f3 = c3.number_input("YÃ¼z 3", value=20)
f4 = c1.number_input("YÃ¼z 4", value=20)
f5 = c2.number_input("YÃ¼z 5 (Zor)", value=10)
f6 = c3.number_input("YÃ¼z 6", value=20)

# OlasÄ±lÄ±klarÄ± Normalize Et (Toplam 1'e eÅŸitlensin)
face_weights = np.array([f1, f2, f3, f4, f5, f6])
face_probs = face_weights / face_weights.sum()

if face_weights.sum() != 100:
    st.sidebar.warning(f"Toplam aÄŸÄ±rlÄ±k: {face_weights.sum()} (Otomatik normalize ediliyor)")

# 4. Nadirlik AyarlarÄ± (Rarity Config)
st.sidebar.subheader("4. Nadirlik (Rarity) AyarlarÄ±")

# Common
st.sidebar.markdown("**Common**")
prob_common = st.sidebar.slider("Common Kategori ÅansÄ± (%)", 0, 100, 75) / 100
count_common = st.sidebar.number_input("Common Skin SayÄ±sÄ±", value=3, min_value=1)

# Rare
st.sidebar.markdown("**Rare**")
prob_rare = st.sidebar.slider("Rare Kategori ÅansÄ± (%)", 0, 100, 15) / 100
count_rare = st.sidebar.number_input("Rare Skin SayÄ±sÄ±", value=2, min_value=1)

# Epic
st.sidebar.markdown("**Epic**")
prob_epic = st.sidebar.slider("Epic Kategori ÅansÄ± (%)", 0, 100, 10) / 100
count_epic = st.sidebar.number_input("Epic Skin SayÄ±sÄ±", value=1, min_value=1)

# Toplam OlasÄ±lÄ±k KontrolÃ¼
total_prob = prob_common + prob_rare + prob_epic
if abs(total_prob - 1.0) > 0.01:
    st.sidebar.error(f"Kategori olasÄ±lÄ±klarÄ± toplamÄ± %{total_prob*100:.0f}! LÃ¼tfen %100 yapÄ±n.")

# --- SÄ°MÃœLASYON MOTORU ---
def run_simulation(n_sims, probs):
    """
    Kupon ToplayÄ±cÄ±sÄ± SimÃ¼lasyonu
    Belirtilen olasÄ±lÄ±klarla 6 yÃ¼zÃ¼ tamamlamak iÃ§in kaÃ§ parÃ§a gerektiÄŸini hesaplar.
    """
    results = []
    faces = np.arange(6)

    # HÄ±z iÃ§in basit dÃ¶ngÃ¼ (Daha bÃ¼yÃ¼k sayÄ±lar iÃ§in Numba kullanÄ±labilir)
    for _ in range(n_sims):
        collected = set()
        count = 0
        while len(collected) < 6:
            count += 1
            face = np.random.choice(faces, p=probs)
            collected.add(face)
        results.append(count)
    return np.array(results)

# Butona basÄ±nca Ã§alÄ±ÅŸtÄ±r
if st.sidebar.button("ğŸš€ SimÃ¼lasyonu BaÅŸlat"):
    with st.spinner('Zarlar atÄ±lÄ±yor, sandÄ±klar aÃ§Ä±lÄ±yor...'):

        # 1. ParÃ§a Toplama SimÃ¼lasyonu
        sim_results = run_simulation(num_simulations, face_probs)

        # Ä°statistikler
        avg_pieces_needed = np.mean(sim_results)
        p75_pieces_needed = np.percentile(sim_results, 75)
        p90_pieces_needed = np.percentile(sim_results, 90)

        # --- SONUÃ‡ PANELÄ° ---

        # A. Temel Metrikler
        st.header("ğŸ“Š Analiz SonuÃ§larÄ±")
        col1, col2, col3 = st.columns(3)
        col1.metric("Ortalama ParÃ§a Gereksinimi", f"{avg_pieces_needed:.2f}")
        col2.metric("P75 (%75 Garanti)", f"{p75_pieces_needed:.0f} ParÃ§a")
        col3.metric("P90 (%90 Garanti)", f"{p90_pieces_needed:.0f} ParÃ§a")

        # B. Skin BazlÄ± Ekonomi Tablosu
        st.subheader("ğŸ›  Skin Tamamlama SÃ¼releri (Time-to-Value)")

        data = []
        rarities = [
            ("Common", prob_common, count_common),
            ("Rare", prob_rare, count_rare),
            ("Epic", prob_epic, count_epic)
        ]

        for name, cat_prob, count in rarities:
            if count > 0 and cat_prob > 0:
                # Spesifik bir itemin Ã§Ä±kma ÅŸansÄ±
                specific_prob = cat_prob / count

                # Gereken SandÄ±k (Ortalama)
                chests_needed_avg = avg_pieces_needed / (avg_pieces_per_chest * specific_prob)
                days_needed_avg = chests_needed_avg / daily_chests

                # Gereken SandÄ±k (P75 - Hedef Kitle)
                chests_needed_p75 = p75_pieces_needed / (avg_pieces_per_chest * specific_prob)
                days_needed_p75 = chests_needed_p75 / daily_chests

                data.append({
                    "Rarity": name,
                    "Specific Drop Rate (%)": f"%{specific_prob*100:.2f}",
                    "Avg Chests": round(chests_needed_avg, 1),
                    "Avg Days": round(days_needed_avg, 1),
                    "P75 Chests (Target)": round(chests_needed_p75, 1),
                    "P75 Days (Target)": round(days_needed_p75, 1)
                })

        df_results = pd.DataFrame(data)
        st.dataframe(df_results, use_container_width=True)

        # C. Hedef KontrolÃ¼ (Goal Check)
        st.subheader("ğŸ¯ Hedef Analizi: Ä°lk 2 Hafta (Common Skin)")

        target_days = 14
        p75_common_days = df_results[df_results["Rarity"]=="Common"]["P75 Days (Target)"].values[0]

        delta = target_days - p75_common_days
        if delta >= 0:
            st.success(f"BAÅARILI! P75 oyuncular ilk Common skini {p75_common_days} gÃ¼nde tamamlÄ±yor. (Hedefin {delta:.1f} gÃ¼n altÄ±nda)")
        else:
            st.error(f"BAÅARISIZ! P75 oyuncular {p75_common_days} gÃ¼nde tamamlÄ±yor. Hedefin {-delta:.1f} gÃ¼n gerisindeyiz.")
            st.markdown("**Ã–neri:** SandÄ±k iÃ§eriÄŸini artÄ±rÄ±n veya yÃ¼z olasÄ±lÄ±klarÄ±nÄ± eÅŸitleyin.")

        # D. GÃ¶rselleÅŸtirme
        st.subheader("ğŸ“ˆ ParÃ§a Gereksinim DaÄŸÄ±lÄ±mÄ±")
        fig = px.histogram(sim_results, nbins=30,
                           title="6 YÃ¼zÃ¼ Tamamlamak Ä°Ã§in Gereken Toplam ParÃ§a SayÄ±sÄ± DaÄŸÄ±lÄ±mÄ±",
                           labels={'value': 'Gereken ParÃ§a SayÄ±sÄ±', 'count': 'Oyuncu SayÄ±sÄ±'})

        fig.add_vline(x=avg_pieces_needed, line_dash="dash", line_color="green", annotation_text="Ortalama")
        fig.add_vline(x=p75_pieces_needed, line_dash="dash", line_color="red", annotation_text="P75")

        st.plotly_chart(fig, use_container_width=True)

else:
    st.info("SimÃ¼lasyonu baÅŸlatmak iÃ§in soldaki butona basÄ±n.")  

